<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.auth0.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
    connect-src 'self' https://dev-6l3jcnaf0wzmpdc2.us.auth0.com;
    font-src 'self' https://fonts.gstatic.com;
  ">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bloo - Your Personal Education AI</title>
  <!-- Load Fonts and Bootstrap (integrity removed to avoid digest errors) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        crossorigin="anonymous">
  <style>
    /* Bloobot dark theme CSS */
    body {
      background: #040026;
      color: #e0e0e0;
      font-family: 'Roboto', sans-serif;
      padding: 20px;
    }
    .main-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .dropzone-container {
      flex: 1;
      max-width: 300px;
      height: 575px;
      background: #1e1e1e;
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #ccc;
      transition: background 0.3s ease;
      cursor: pointer;
    }
    .dropzone-container.hover {
      background: #2c2c2c;
    }
    .dropzone-container p { margin: 0; }
    .supported-formats {
      margin-top: 15px;
      font-size: 14px;
      color: #aaa;
    }
    .supported-formats ul {
      list-style: none;
      padding-left: 0;
      margin: 5px 0 0;
    }
    .supported-formats li {
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    .supported-formats img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 5px;
    }
    /* NEW: File list container styling */
    #file-list {
      margin-top: 15px;
      text-align: left;
    }
    #file-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #file-list li {
      margin-bottom: 5px;
      font-size: 14px;
      color: #ddd;
    }
    #file-list li span.file-icon {
      margin-right: 5px;
    }
    #uploadBtn {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #uploadBtn:hover { background-color: #218838; }
    .chat-container {
      flex: 2;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .chat-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }
    .chat-header h2 { margin: 0; color: #fff; }
    .messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: #2c2c2c;
    }
    .message {
      margin-bottom: 10px;
      font-size: 16px;
      padding: 8px;
      border-radius: 5px;
    }
    .message.user {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .message.bot {
      background: rgba(173, 216, 230, 0.1);
      color: #add8e6;
    }
    textarea.form-control {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 5px;
    }
    .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-group textarea { width: 80%; margin-right: 10px; }
    button#send {
      background: #007bff;
      border: none;
      border-radius: 50%;
      font-weight: 500;
      transition: background 0.3s ease;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    button#send:hover { background: #0056b3; }
    #preset-prompts {
      margin-bottom: 15px;
      text-align: center;
    }
    #preset-prompts button {
      margin: 0 5px;
      background: #007bff;
      border: none;
      color: #fff;
      transition: background 0.3s ease;
      padding: 8px 12px;
      border-radius: 4px;
    }
    #preset-prompts button:hover { background: #0056b3; }
    .info-container {
      flex: 1;
      max-width: 300px;
      background: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      color: #ccc;
    }
    .info-container h3 { color: #fff; margin-bottom: 15px; }
    .info-container ul { list-style: none; padding-left: 0; }
    .info-container li {
      margin-bottom: 10px;
      padding-left: 20px;
      position: relative;
    }
    .info-container li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: #007bff;
    }
    #progressContainer {
      width: 100%;
      height: 4px;
      background: transparent;
      border: 1px solid white;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 10px;
      display: none;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #fff;
      transition: width 0.2s ease-in-out;
    }
    /* Loading Overlay for file uploads */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #007bff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    /* File upload progress bar */
    #upload-progress-container {
      width: 80%;
      height: 4px;
      background: transparent;
      border: 1px solid white;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 20px;
      display: none;
    }
    #upload-progress-bar {
      width: 0%;
      height: 100%;
      background-color: #fff;
      transition: width 0.2s ease-in-out;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Auth buttons styling */
    #auth-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
    }
    /* Notification Popup */
    #notification-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 15px 20px;
      border-radius: 5px;
      display: none;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    @media (max-width: 576px) {
      .main-container { flex-direction: column; }
      .dropzone-container, .chat-container, .info-container { max-width: 100%; }
      .input-group textarea { width: 70%; }
      button#send { width: 35px; height: 35px; font-size: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Auth0 Login/Signup UI -->
  <div id="auth-buttons">
    <button id="login-btn" class="btn btn-primary" disabled>Login / Signup</button>
    <button id="logout-btn" class="btn btn-secondary" style="display:none;">Logout</button>
  </div>

  <!-- Page 1: Welcome Screen -->
  <div id="page-welcome" class="page" style="display:none;">
    <div class="container text-center" style="margin-top: 100px;">
      <!-- NEW: Logo placeholder -->
      <img src="assets/logo.png" alt="Logo" style="max-width:200px; margin-bottom:20px;">
      <h1>Welcome to Bloo</h1>
      <p>Please sign in or create an account to continue.</p>
      <button id="welcome-login-btn" class="btn btn-primary">Sign In / Create Account</button>
    </div>
  </div>

  <!-- Page 2: Upload Screen -->
  <div id="page-upload" class="page" style="display:none;">
    <div class="container text-center">
      <!-- File Upload Section -->
      <div id="drop-zone" class="dropzone-container mx-auto">
        <p>Drag & drop your file here<br>or click to select</p>
        <input type="file" id="fileUpload" accept=".pdf,.pptx,.docx" multiple style="display: none;">
        <button id="uploadBtn" class="btn">Upload File</button>
        <div class="supported-formats">
          <p>Supported documents:</p>
          <ul class="list-inline">
            <li class="list-inline-item"><img src="assets/pdf-logo.png" alt="PDF"> .pdf</li>
            <li class="list-inline-item"><img src="assets/docx-logo.png" alt="DOCX"> .docx</li>
            <li class="list-inline-item"><img src="assets/pptx-logo.png" alt="PPTX"> .pptx</li>
          </ul>
        </div>
        <!-- File list container -->
        <div id="file-list"></div>
      </div>
      <!-- NEW: Skip to Chat button placed outside the drop zone -->
      <button id="skip-btn" class="btn btn-secondary mt-3">Skip to Chat</button>
    </div>
  </div>

  <!-- Page 3: Chat Screen -->
  <div id="page-chat" class="page" style="display:none;">
    <div class="container">
      <div class="main-container">
        <!-- Chat Section -->
        <div class="chat-container">
          <div class="chat-header">
            <img src="assets/bloobotlogoimage.png" alt="Bloo Profile Picture">
            <h2>Bloo</h2>
          </div>
          <div class="messages mb-3" id="messages"></div>
          <div id="progressContainer">
            <div id="progressBar"></div>
          </div>
          <div id="preset-prompts" class="mb-3">
            <button class="btn preset-btn" data-prompt="I need help with my homework">Help with homework</button>
            <button class="btn preset-btn" data-prompt="I want you to summarize this reading for my class">Summarize reading</button>
            <button class="btn preset-btn" data-prompt="What can you help me with?">More</button>
          </div>
          <div class="input-group mb-3">
            <textarea id="prompt" class="form-control" placeholder="Hey, I'm Bloo. What class can I help you with?" rows="1" style="resize: none;"></textarea>
            <button id="send" class="btn">&#8594;</button>
          </div>
          <!-- Upload More Files Button -->
          <div style="margin-top: 20px; text-align: center;">
            <button id="back-to-upload-btn" class="btn btn-secondary">Upload More Files</button>
          </div>
        </div>
        <!-- Information Panel -->
        <div class="info-container">
          <h3>What Bloo Can Do</h3>
          <ul>
            <li>Analyze your coursework files</li>
            <li>Break down homework & assignments</li>
            <li>Provide step-by-step guidance</li>
            <li>Customize responses (coursework-specific or general)</li>
            <li>Promote deeper learning through interactive explanations</li>
          </ul>
          <div class="slider-prototype mt-4">
            <input type="range" min="0" max="100" value="50" style="width: 100%;">
            <small class="d-block mt-1 text-muted">This is a prototype. This does not work yet.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay for file uploads -->
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="upload-progress-container">
      <div id="upload-progress-bar"></div>
    </div>
  </div>

  <!-- Notification Popup -->
  <div id="notification-popup">File uploaded successfully!</div>

  <!-- Script dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Load Auth0 SPA SDK (version 2.0) before our custom script -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <!-- Combined Auth0 and Bloobot logic -->
  <script>
    // --------- Utility: Simple Router -----------
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
      document.getElementById(pageId).style.display = 'block';
    }

    // --------- Auth0 Integration -----------
    let auth0Client = null;
    let userProfile = null;

    const fetchAuthConfig = () => fetch("/auth_config.json");

    const configureClient = async () => {
      try {
        const response = await fetchAuthConfig();
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          redirect_uri: window.location.origin,
          cacheLocation: "localstorage"
          // Uncomment and set audience if you use a custom API:
          // audience: "YOUR_API_IDENTIFIER"
        });
      } catch (err) {
        console.log("Error configuring Auth0 client:", err);
      }
    };

    const login = async (targetUrl) => {
      try {
        const options = {
          authorizationParams: {
            redirect_uri: window.location.origin,
            scope: "openid profile email"
          }
        };
        if (targetUrl) { options.appState = { targetUrl }; }
        await auth0Client.loginWithRedirect(options);
      } catch (err) {
        console.log("Log in failed", err);
      }
    };

    const logout = async () => {
      try {
        await auth0Client.logout({
          logoutParams: { returnTo: window.location.origin }
        });
        updateAuthUI();
        showPage("page-welcome");
      } catch (err) {
        console.log("Log out failed", err);
      }
    };

    const updateAuthUI = async () => {
      try {
        const isAuthenticated = await auth0Client.isAuthenticated();
        console.log("updateAuthUI: isAuthenticated =", isAuthenticated);
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        if (isAuthenticated) {
          userProfile = await auth0Client.getUser();
          console.log("updateAuthUI: userProfile =", userProfile);
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
        } else {
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
        }
      } catch (err) {
        console.log("Error updating UI!", err);
      }
    };

    // --------- Attach Auth0 event listeners and process redirect callback -----------
    window.onload = async () => {
      await configureClient();
      console.log("Auth0 client configured:", auth0Client);
      // Enable the login button once Auth0 is ready.
      document.getElementById("login-btn").disabled = false;
      
      // Process redirect callback if present.
      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        try {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, "/");
          window.location.reload();
          return;
        } catch (err) {
          console.log("Error parsing redirect:", err);
        }
      }
      await updateAuthUI();
      // Show page based on auth state.
      const isAuthenticated = await auth0Client.isAuthenticated();
      if (isAuthenticated) {
        showPage("page-upload");
      } else {
        showPage("page-welcome");
      }
    };

    // Event listener for welcome page login button.
    document.getElementById("welcome-login-btn").addEventListener("click", () => {
      console.log("Welcome login button clicked");
      login();
    });

    // Standard Auth0 buttons.
    document.getElementById("login-btn").addEventListener("click", () => {
      console.log("Login button clicked");
      login();
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
      logout();
    });

    // --------- Skip Button on Upload Page -----------
    document.getElementById("skip-btn").addEventListener("click", () => {
      showPage("page-chat");
    });

    // --------- Upload More Files Button on Chat Page -----------
    document.getElementById("back-to-upload-btn").addEventListener("click", () => {
      showPage("page-upload");
    });

    // --------- Bloobot Chat and File Upload Logic -----------
    let conversation = [];
    const messagesEl = document.getElementById('messages');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const API_URL = window.location.hostname === "localhost"
      ? "http://localhost:8888/.netlify/functions/ask"
      : "https://financeaibot.netlify/functions/ask";

    function addMessage(text, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender + ' mb-2';
      msgDiv.textContent = text;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function markdownToHTML(markdown) {
      let output = markdown;
      output = output.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      output = output.replace(/\*(.+?)\*/g, '<em>$1</em>');
      return output;
    }

    function intoPieces(text) {
      if (/^\s*$/.test(text)) return [text];
      const pieces = text.match(/(\s*\S+\s*)/g);
      return pieces || [];
    }

    function typeWriter(text, element, speed = 30) {
      let i = 0;
      const interval = setInterval(() => {
        element.innerHTML = "<strong>Bloo: </strong>" + markdownToHTML(text.substring(0, i));
        i++;
        if (i > text.length) clearInterval(interval);
      }, speed);
    }

    function addBotMessageWithFormattingAndTyping(text, wpm) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message bot mb-2';
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      const pieces = intoPieces(text);
      const wordsPerMillisecond = wpm / 60000;
      const now = Date.now();
      const interval = setInterval(() => {
        const elapsed = Date.now() - now;
        const expectedCount = Math.min(elapsed * wordsPerMillisecond, pieces.length);
        const segment = pieces.slice(0, expectedCount + 1).join('');
        msgDiv.innerHTML = "<strong>Bloo: </strong>" + markdownToHTML(segment);
        if (expectedCount >= pieces.length) clearInterval(interval);
      }, 200);
    }

    // Chat progress functions
    let progressInterval;
    function startProgress() {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = '0%';
      progressContainer.style.display = 'block';
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          progressBar.style.width = progress + '%';
        } else {
          clearInterval(progressInterval);
        }
      }, 200);
    }
    function finishProgress() {
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = '100%';
      clearInterval(progressInterval);
      setTimeout(() => { document.getElementById('progressContainer').style.display = 'none'; }, 500);
    }

    sendBtn.addEventListener('click', async () => {
      const promptText = promptEl.value.trim();
      if (!promptText) return;
      conversation.push({ role: 'user', content: promptText });
      addMessage("You: " + promptText, 'user');
      promptEl.value = '';
      startProgress();
      try {
        // Determine user namespace from userProfile if available, otherwise default to "default"
        const ns = userProfile ? (userProfile.nickname || userProfile.name || userProfile.email) : "default";
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conversation: conversation, userNamespace: ns })
        });
        const data = await response.json();
        if (data.response) {
          conversation.push({ role: 'assistant', content: data.response });
          addBotMessageWithFormattingAndTyping(data.response, 1000);
        } else {
          addMessage("Bloo: (No response)", 'bot');
        }
      } catch (err) {
        console.error(err);
        addMessage("Bloo: Error connecting to server.", 'bot');
      } finally {
        finishProgress();
      }
    });

    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    document.querySelectorAll('.preset-btn').forEach(button => {
      button.addEventListener('click', () => {
        promptEl.value = button.getAttribute('data-prompt');
        sendBtn.click();
      });
    });

    // File upload logic
    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("fileUpload");

    dropZone.addEventListener("click", () => { fileInput.click(); });
    dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("hover"); });
    dropZone.addEventListener("dragleave", (e) => { e.preventDefault(); dropZone.classList.remove("hover"); });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      const droppedFiles = e.dataTransfer.files;
      if (droppedFiles.length) {
        updateFileList(Array.from(droppedFiles));
        handleFileUploads(droppedFiles);
      }
    });
    fileInput.addEventListener("change", (e) => {
      const selectedFiles = e.target.files;
      if (selectedFiles.length) {
        updateFileList(Array.from(selectedFiles));
        handleFileUploads(selectedFiles);
      }
    });

    let uploadProgressInterval;
    function startUploadProgress() {
      const container = document.getElementById("upload-progress-container");
      const bar = document.getElementById("upload-progress-bar");
      bar.style.width = "0%";
      container.style.display = "block";
      let progress = 0;
      uploadProgressInterval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          bar.style.width = progress + "%";
        } else {
          clearInterval(uploadProgressInterval);
        }
      }, 200);
    }
    function finishUploadProgress() {
      const bar = document.getElementById("upload-progress-bar");
      bar.style.width = "100%";
      clearInterval(uploadProgressInterval);
      setTimeout(() => { document.getElementById("upload-progress-container").style.display = "none"; }, 500);
    }
    function handleFileUploads(fileList) {
      document.getElementById("loading-overlay").style.display = "flex";
      startUploadProgress();
      const files = Array.from(fileList);
      const uploads = files.map(file => uploadFile(file));
      // Use Promise.allSettled so that if at least one file succeeds, we show success
      Promise.allSettled(uploads)
        .then((results) => {
          finishUploadProgress();
          const successful = results.filter(r => r.status === "fulfilled");
          if (successful.length > 0) {
            const notification = document.getElementById("notification-popup");
            notification.textContent = "File(s) uploaded successfully!";
            notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; }, 3000);
          } else {
            alert("All file uploads failed.");
          }
        })
        .catch((error) => {
          finishUploadProgress();
          alert("One or more file uploads failed.");
        })
        .finally(() => {
          setTimeout(() => { document.getElementById("loading-overlay").style.display = "none"; }, 500);
        });
    }
    async function uploadFile(file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/.netlify/functions/upload", true);
        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const result = JSON.parse(xhr.responseText);
              console.log("Upload result for", file.name, ":", result);
              resolve(result);
            } catch (err) {
              reject(err);
            }
          } else {
            reject(new Error("Upload failed with status " + xhr.status));
          }
        };
        xhr.onerror = function() { reject(new Error("Network error")); };
        const formData = new FormData();
        formData.append("file", file, file.name);
        if (userProfile) {
          const ns = userProfile.nickname || userProfile.name || userProfile.email;
          formData.append("namespace", ns);
        }
        xhr.send(formData);
      });
    }
    
    // NEW: Function to update the file list UI in the drop zone
    function updateFileList(files) {
      const fileListContainer = document.getElementById("file-list");
      if (!fileListContainer) return;
      let html = "<ul class='list-group'>";
      files.forEach(file => {
        html += `<li class="list-group-item bg-dark text-white"><span class="file-icon">ðŸ“„</span>${file.name}</li>`;
      });
      html += "</ul>";
      fileListContainer.innerHTML = html;
    }
  </script>
  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // Assuming addMessage is defined and available in your scope.
      addMessage("Hey there! What homework can I help you with today?", "bot");
    });
  </script>
  
</body>
</html>
