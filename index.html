<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.auth0.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
    connect-src 'self' https://dev-6l3jcnaf0wzmpdc2.us.auth0.com;
    font-src 'self' https://fonts.gstatic.com;
  ">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bloo - Your Personal Education AI</title>
  <link rel="manifest" href="/manifest.json?v=5678">
  <!-- Load Fonts and Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        crossorigin="anonymous">
  <style>
    /* Bloo Light Theme CSS */
    body {
      background: #ffffff;
      color: #212529;
      font-family: 'Roboto', sans-serif;
      padding: 20px;
      margin: 0; /* remove default margin for a flush hero section */
    }
    .page {
      display: none;
      pointer-events: auto;
    }
    .main-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    /* Modernized Dropzone Styles */
    .dropzone-container {
      flex: 1;
      max-width: 300px;
      height: 575px;
      background: #ffffff;
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      color: #495057;
      transition: background 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    .dropzone-container:hover {
      background: #e9ecef;
    }
    .dropzone-container svg {
      margin-bottom: 15px;
    }
    .dropzone-container p {
      margin: 0 0 15px;
      font-size: 16px;
    }
    .dropzone-container input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
    }
    .supported-formats {
      margin-top: 15px;
      font-size: 14px;
      color: #6c757d;
    }
    .supported-formats ul {
      list-style: none;
      padding-left: 0;
      margin: 5px 0 0;
    }
    .supported-formats li {
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }
    .supported-formats img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 5px;
    }
    /* File list styling */
    #file-list {
      margin-top: 15px;
      text-align: left;
    }
    #file-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #file-list li {
      margin-bottom: 5px;
      font-size: 14px;
      color: #495057;
    }
    #file-list li span.file-icon {
      margin-right: 5px;
    }
    /* Chat Container */
    .chat-container {
      flex: 2;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #ced4da;
    }
    .chat-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }
    .chat-header h2 { margin: 0; color: #212529; }
    .messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ced4da;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: #f8f9fa;
    }
    .message {
      margin-bottom: 10px;
      font-size: 16px;
      padding: 8px;
      border-radius: 5px;
    }
    .message.user {
      background: #e9ecef;
      color: #212529;
    }
    .message.bot {
      background: #cce5ff;
      color: #004085;
      padding: 8px;
      border-radius: 5px;
    }
    textarea.form-control {
      background: #ffffff;
      color: #212529;
      border: 1px solid #ced4da;
      border-radius: 5px;
      width: 100%;
      padding-right: 50px; /* make space for the arrow button */
    }
    /* Chat input with arrow inside */
    .chat-input-container {
      position: relative;
      margin-bottom: 1rem;
    }
    #send {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      background: #007bff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #send:hover { background: #0056b3; }
    /* Info Container */
    .info-container {
      flex: 1;
      max-width: 300px;
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      color: #495057;
      border: 1px solid #ced4da;
    }
    .info-container h3 { color: #212529; margin-bottom: 15px; }
    .info-container ul { list-style: none; padding-left: 0; }
    .info-container li {
      margin-bottom: 10px;
      padding-left: 20px;
      position: relative;
    }
    .info-container li::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: #007bff;
    }
    /* New Upload Info Block CSS */
    .upload-info h2 {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .upload-info p {
      font-size: 16px;
      color: #212529;
      margin-bottom: 1rem;
    }
    #progressContainer {
      width: 100%;
      height: 4px;
      background: transparent;
      border: 1px solid #ced4da;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 10px;
      display: none;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #007bff;
      transition: width 0.2s ease-in-out;
    }
    /* Loading Overlay for file uploads */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #007bff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    /* File upload progress bar */
    #upload-progress-container {
      width: 80%;
      height: 4px;
      background: transparent;
      border: 1px solid #ced4da;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 20px;
      display: none;
    }
    #upload-progress-bar {
      width: 0%;
      height: 100%;
      background-color: #007bff;
      transition: width 0.2s ease-in-out;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Auth buttons styling */
    #auth-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
    }
    /* Notification Popup */
    #notification-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 15px 20px;
      border-radius: 5px;
      display: none;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    /* Feature Boxes Styling */
    .feature-box {
      background: #ffffff;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      padding: 20px;
    }
    .feature-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }
    .feature-box h4 {
      font-weight: 500;
      margin-bottom: 10px;
    }
    .feature-box p {
      font-size: 14px;
      color: #6c757d;
      margin-bottom: 0;
    }
    @media (max-width: 576px) {
      .main-container { flex-direction: column; }
      .dropzone-container, .chat-container, .info-container { max-width: 100%; }
      textarea.form-control { padding-right: 50px; }
      #send { width: 35px; height: 35px; font-size: 1rem; }
    }

    /* 
      -----------------------------------------
      NEW LANDING PAGE SECTIONS (Funnel Layout)
      -----------------------------------------
    */
    /* Page-Landing: Hero, Features, CTA */
    #page-landing {
      /* We'll make it the top-level funnel page if user is not authenticated */
      min-height: 100vh;
      display: none; /* hidden by default, revealed in script */
      pointer-events: auto;
    }
    .hero-section {
      background: #ffffff;
      padding: 80px 20px;
      text-align: center;
    }
    .hero-section h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .hero-section p.lead {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      max-width: 600px;
      margin: 0 auto 1.5rem auto;
    }
    .hero-section img {
      max-width: 200px;
      margin-bottom: 20px;
    }
    .features-section {
      background: #ffffff;
      padding: 60px 20px;
    }
    .features-section h3 {
      font-weight: 500;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    .features-section p {
      font-size: 1rem;
      color: #6c757d;
    }
    .cta-section {
      background: #007bff;
      color: #ffffff;
      text-align: center;
      padding: 50px 20px;
    }
    .cta-section h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .cta-section p {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Auth0 Login/Signup UI -->
  <div id="auth-buttons">
    <button id="login-btn" class="btn btn-primary" disabled>Login / Signup</button>
    <button id="logout-btn" class="btn btn-modern" style="display:none; background: linear-gradient(135deg, #05002b, #002490); color: #fff; border: none;">
      Logout
    </button>
    
  </div>

 <!-- ========================================= -->
<!-- PAGE 0: Landing Page (Funnel Layout) -->
<!-- ========================================= -->
 
<div id="page-landing" class="page" style="min-height: 100vh; background: no-repeat center center; background-size: cover;">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="container">
      <img src="assets/bloobotlogoofficialblacktext.png" alt="Bloobot Logo" />
      <h1>Your<span style="color: #0d6efd; font-style: bold;"> AI-Powered</span>  Homework Helper
      </h1>

      <p class="lead">
        Transform the way you complete assignments with Bloobotâ€™s AI-driven insights,
        100% coursework accurate answers, and step-by-step homework guidance.
      </p>
      <!-- "Get Started" => leads to page-welcome or page-info -->
      <button id="landing-get-started-btn" class="btn btn-primary btn-lg">Get Started</button>
    </div>
  </section>

  <script>
    function showLandingPage() {
      // Hide the current page
      document.getElementById('page-info').style.display = 'none';
      // Show the landing page
      document.getElementById('page-landing').style.display = 'block';
    }
  </script>

  <!-- How Bloobot Works Section (Numbered Phones + Corresponding Icons) -->
  <section class="how-bloobot-works" style="
    background: linear-gradient(135deg, #ffffff, #f7f9fa);
    padding: 60px 0;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    margin: 40px 0;
    position: relative;
  ">
    <div class="container">
      <div class="row align-items-center">
        <!-- Left Side: Numbered Phone Mockups -->
        <div class="col-md-6 d-flex justify-content-center justify-content-md-start" style="position: relative;">
          <!-- Phone 1 with Number -->
          <div style="position: relative; margin-right: 20px;">
            <img 
              src="assets/phone-example-1.png" 
              alt="Bloo on Mobile 1" 
              style="
                width: 210px; 
                border-radius: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              "
            >
            <!-- Number Badge for Phone 1 -->
            <div style="
              position: absolute;
              top: -10px; 
              left: -10px;
              background: #0d6efd; 
              color: #fff; 
              padding: 8px 12px; 
              border-radius: 8px; 
              font-weight: bold; 
              font-size: 1.2rem;
            ">
              1
            </div>
          </div>

          <!-- Phone 2 with Number -->
          <div style="position: relative;">
            <img 
              src="assets/phone-example-2.png" 
              alt="Bloo on Mobile 2" 
              style="
                width: 210px; 
                border-radius: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
              "
            >
            <!-- Number Badge for Phone 2 -->
            <div style="
              position: absolute;
              top: -10px; 
              left: -10px;
              background: #0d6efd; 
              color: #fff; 
              padding: 8px 12px; 
              border-radius: 8px; 
              font-weight: bold; 
              font-size: 1.2rem;
            ">
              2
            </div>
          </div>

        </div>

        <!-- Right Side: Steps with Corresponding Icons in Elevated Boxes -->
        <div class="col-md-6 text-start mt-4 mt-md-0">
          <h2 style="font-weight: 600; font-size: 2rem;">How Bloobot Works</h2>
          <p style="font-size: 1rem; margin-top: 10px; color: #555;">
            Quick and easy steps to get the most out of Bloo:
          </p>
          <ol style="font-size: 18px; margin-top: 20px; line-height: 1.8; color: #333; list-style-type: none; padding-left: 0;">
            <li style="margin-bottom: 15px;">
              <div style="
                background: #fff;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
              ">
                <img src="assets/1-intro.png" alt="Step 1 Icon" style="width: 40px; height: 40px; margin-right: 10px;">
                <div>
                  <strong>Upload Coursework:</strong> Provide your PDFs, Word docs, PowerPoints, Excel files, or images for Bloo to analyze.
                </div>
              </div>
            </li>
            <li>
              <div style="
                background: #fff;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
              ">
                <img src="assets/2-intro.png" alt="Step 2 Icon" style="width: 40px; height: 40px; margin-right: 10px;">
                <div>
                  <strong>Chat with Bloo:</strong> Ask questions and get step-by-step guidance tailored to your course content.
                </div>
              </div>
            </li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Features Section with 3D Effect -->
  <section class="features-section" style="
    background-color: #f5f5f5; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
    border-radius: 12px; 
    padding: 40px 0; 
    margin: 40px 0;
  ">
    <div class="container">
      <div class="row text-center">
        <div class="col-md-4 mb-4">
          <img src="assets/files-icon.png" alt="Analyze Files" style="width:60px;" />
          <h3>Analyze Your Files</h3>
          <p>
            Bloobot quickly ingests your PDFs, Word docs, PowerPoints, Excel files, and images
            to provide coursework-specific answers and deeper insights into your coursework.
          </p>
        </div>
        <div class="col-md-4 mb-4">
          <img src="assets/homework-icon.png" alt="Homework Guidance" style="width:60px;" />
          <h3>Homework Guidance</h3>
          <p>
            Struggling with assignments? Let Bloobot break down complex tasks into
            simpler steps and walk you through each stage for better understanding.
          </p>
        </div>
        <div class="col-md-4 mb-4">
          <img src="assets/study-tips-icon.png" alt="Study Tips" style="width:60px;" />
          <h3>Study Tips &amp; More</h3>
          <p>
            From interactive Q&amp;A to personalized study recommendations, Bloobot
            helps you focus on the topics that matter most.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Already Signed In Banner -->
  <section id="signed-in-banner" style="display: none; background: rgba(255,255,255,0.8); padding: 15px 0; text-align: center; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd;">
    <p style="margin: 0; font-size: 16px;">
      Already signed in? 
      <a href="/chat.html" class="btn btn-link" style="font-size: 16px; text-decoration: underline;">Use Bloo</a>
    </p>
  </section>

  <!-- CTA Section -->
  <section class="cta-section" style="cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 12px;">
    <div class="container">
      <h2>Ready to Ace Your Classes?</h2>
      <p>
        Join hundreds of students who trust Bloobot to simplify coursework and maximize learning efficiency.
      </p>
      <!-- "Sign Up for Free" => triggers login or create account -->
      <button id="landing-signup-btn" class="btn btn-light btn-lg">Sign Up for Free</button>
    </div>
  </section>
</div>

<!-- New CSS for hover effect on CTA Section -->
<style>
  .cta-section:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  }
</style>

<!-- Simple Script to Toggle Signed In Banner -->
<script>
  // Dummy condition: replace with your actual authentication check.
  const isSignedIn = false; // Change this to true to test the banner.

  if (isSignedIn) {
    document.getElementById('signed-in-banner').style.display = 'block';
  }
</script>
<!-- END of PAGE 0: Landing Page -->

 <!-- Page 1: Welcome Screen (Two-Column Layout) -->
<div id="page-welcome" class="page" style="min-height: 100vh; background: #f8f9fa; position: relative;">
  <!-- Modern Back Button positioned at the top left -->
  <button id="back-to-landing-btn" class="btn btn-outline-primary btn-modern-back" 
  style="position: absolute; top: 20px; left: 20px;" 
  onclick="showLandingPage();">
  &larr; Back to Home
</button>

  <div class="container py-5">
    <div class="row align-items-center">
      <!-- Left Column: Info Box -->
      <div class="col-md-6 d-flex justify-content-center mb-4 mb-md-0">
        <div class="card p-5 shadow" style="background: rgba(0, 123, 255, 0.9); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 100%; max-width: 500px;">
          <h1 class="mb-4" style="font-size: 2.5rem; font-weight: 700; color: #fff; text-align: center;">
            Your <span style="color: #ffffff;">AI-Powered</span> Homework Helper
          </h1>
          <div class="row g-3 mb-4">
            <!-- Feature 1 -->
            <div class="col-6">
              <h4 class="fw-bold" style="color: #fff; text-align: center;">24/7</h4>
              <p style="color: #fff; text-align: center;">Personal Tutor</p>
            </div>
            <!-- Feature 2 -->
            <div class="col-6">
              <h4 class="fw-bold" style="color: #fff; text-align: center;">Rapid</h4>
              <p style="color: #fff; text-align: center;">Processing</p>
            </div>
            <!-- Feature 3 -->
            <div class="col-6">
              <h4 class="fw-bold" style="color: #fff; text-align: center;">Instant</h4>
              <p style="color: #fff; text-align: center;">Responses</p>
            </div>
            <!-- Feature 4 -->
            <div class="col-6">
              <h4 class="fw-bold" style="color: #fff; text-align: center;">100%</h4>
              <p style="color: #fff; text-align: center;">Accurate</p>
            </div>
          </div>
          <p style="color: #fff; text-align: center;">
            Bloo is built <strong>exclusively</strong> for students and educators, offering personalized, <strong>coursework-based</strong> assistance that understands your coursework and helps you succeed.
          </p>
        </div>
      </div>
      <!-- Right Column: Sign-In Card -->
      <div class="col-md-6 d-flex justify-content-center">
        <div class="card p-4 shadow" style="max-width: 400px; width: 100%; background: rgba(248,249,250,0.95); border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          <div class="text-center mb-4">
            <img src="assets/bloobotlogoofficialblacktext.png" alt="Logo" style="max-width:150px;">
          </div>
          <h1 class="h3 text-center mb-3" style="color: #212529;">Welcome to Bloo</h1>
          <p class="text-center text-muted mb-4">Sign in or create an account to continue</p>
          <div class="d-grid gap-2">
            <button id="sign-in-btn" class="btn btn-primary btn-modern">Sign In</button>
            <button id="create-account-btn" class="btn btn-outline-secondary btn-modern">Create Account</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New CSS for modern buttons -->
<style>
  .btn-modern {
    border-radius: 25px;
    font-weight: 500;
    padding: 12px 24px;
    transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
  }
  .btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }
</style>

<!-- New Page: Next Steps for Bloo -->
<div id="page-info" class="page" style="padding: 2rem 0;">
  <div class="container">
    <!-- Modern Back Button -->
    <div class="mb-4 text-start">
      <button id="back-to-landing-btn" class="btn btn-outline-primary" 
              style="border-radius: 50px; padding: 0.5rem 1rem;" 
              onclick="showLandingPage();">
        &larr; Back to Home
      </button>
    </div>
    <!-- Next Steps Card -->
    <div class="card mx-auto shadow" style="max-width: 600px; border: none; border-radius: 15px;">
      <div class="card-body text-center p-5">
        <h2 class="card-title mb-4" style="font-weight: 600;">What to Do Next</h2>
        <p class="card-text mb-4" style="font-size: 1.1rem; line-height: 1.5;">
          With Bloo, you can quickly get personalized answers based on your coursework.
          Choose your next step below:
        </p>
        <ul class="list-group list-group-flush mb-4 text-start" style="font-size: 1rem;">
          <li class="list-group-item border-0 ps-0 d-flex align-items-start">
            <img src="assets/1-intro.png" alt="Step 1" style="width: 32px; height: 32px; margin-right: 12px; margin-top: 4px;">
            <div>
              <strong>Upload Your Files:</strong> Let Bloo analyze your course materials to generate tailored insights.
            </div>
          </li>
          <li class="list-group-item border-0 ps-0 d-flex align-items-start">
            <img src="assets/2-intro.png" alt="Step 2" style="width: 32px; height: 32px; margin-right: 12px; margin-top: 4px;">
            <div>
              <strong>Chat with Bloo:</strong> Once you upload your files, start a conversation for coursework-relevant homework help.
            </div>
          </li>
        </ul>
      </div>
    </div>
    <!-- Action Buttons -->
    <div class="d-flex justify-content-center gap-3 mt-4">
      <button id="upload-files-btn" class="btn btn-primary btn-lg" style="border-radius: 50px; padding: 0.75rem 1.5rem;">Upload Files</button>
      <button id="skip-to-bloo-btn" class="btn btn-lg animated-gradient">
        Chat with Bloo
      </button>
    </div>
  </div>
</div>

<style>
  .animated-gradient {
  background: linear-gradient(270deg, #a1c4fd, #00c95e);
  background-size: 400% 400%;
  animation: gradientFlow 4s ease infinite;
  border-radius: 50px;
  padding: 0.75rem 1.5rem;
  color: #fff;
  border: none;
}
@keyframes gradientFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
</style>
<!-- New CSS for modern back button (if not already defined) -->
<style>
  .btn-modern-back {
    border-radius: 25px;
    font-weight: 500;
    padding: 10px 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .btn-modern-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }
</style>

<!-- New CSS for modern back button -->
<style>
  .btn-modern-back {
    border-radius: 25px;
    font-weight: 500;
    padding: 10px 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .btn-modern-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }
</style>

<!-- Page 2: Upload Screen --> 
<div id="page-upload" class="page">
  <div class="container position-relative" style="max-width: 800px; margin-top: 2rem;">
    <!-- Modern Back Button positioned in the top left using an inline SVG icon -->
    <button id="back-to-info-btn" class="btn btn-light position-absolute" style="top: 1rem; left: 1rem; border: none; background: transparent; cursor: pointer;">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#007bff" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L6.707 7l4.647 4.646a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 0 1 .708 0z"/>
      </svg>
    </button>
    <!-- Card-like Upload Area -->
    <div id="drop-zone" class="dropzone-container mx-auto" style="border: 2px dashed #007bff; border-radius: 12px; padding: 2rem; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background 0.3s ease;">
      <!-- Inline SVG Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#007bff" class="bi bi-cloud-upload mb-3" viewBox="0 0 16 16">
        <path d="M4.406 8.342a5.53 5.53 0 0 1 9.188-1.342A3.5 3.5 0 0 1 15.5 8a3.5 3.5 0 0 1-1.032 2.342A4.5 4.5 0 0 1 8 13.5a4.5 4.5 0 0 1-4.468-3.158zM8 0a5 5 0 0 0-4.546 2.914A3.5 3.5 0 0 0 1.5 7a3.5 3.5 0 0 0 1.032 2.342A4.5 4.5 0 0 0 8 13.5a4.5 4.5 0 0 0 4.468-3.158A3.5 3.5 0 0 0 14.5 7a3.5 3.5 0 0 0-1.032-2.342A5 5 0 0 0 8 0zm.5 8V5h-1v3H5l3 3 3-3h-2.5z"/>
      </svg>
      <p style="font-size: 1.1rem; color: #333;">Drag &amp; drop your coursework here, or click to select</p>
      <!-- Full-size transparent file input for click functionality -->
      <input type="file" id="fileUpload" accept=".pdf,.pptx,.docx,.xlsx,.png,.jpg,.jpeg" multiple style="position: absolute; inset: 0; width: 100%; opacity: 0; cursor: pointer;">
      
      <!-- Supported Formats -->
      <div class="supported-formats mt-3" style="font-size: 0.9rem; color: #666;">
        <p>Supported documents:</p>
        <ul class="list-inline" style="padding-left: 0; margin: 0;">
          <li class="list-inline-item mx-1"><img src="assets/pdf-logo.png" alt="PDF" style="width:24px;"> .pdf</li>
          <li class="list-inline-item mx-1"><img src="assets/docx-logo.png" alt="DOCX" style="width:24px;"> .docx</li>
          <li class="list-inline-item mx-1"><img src="assets/pptx-logo.png" alt="PPTX" style="width:24px;"> .pptx</li>
          <li class="list-inline-item mx-1"><img src="assets/excel-logo.png" alt="Excel" style="width:24px;"> .xlsx</li>
          <li class="list-inline-item mx-1"><img src="assets/image-logo.png" alt="Image" style="width:24px;"> .png, .jpg, .jpeg</li>
        </ul>
      </div>
      <!-- File Upload History -->
      <div id="file-list" style="margin-top: 20px; text-align: left;">
        <h5>Uploaded Coursework:</h5>
        <ul id="uploaded-files" style="list-style: none; padding-left: 0;"></ul>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="text-center mt-4">
      <button id="chat-btn" class="btn btn-primary px-4 py-2" style="font-size: 1.1rem;">Chat with Bloo</button>
      <br>
      <button id="skip-btn" class="btn btn-secondary mt-2 px-4 py-2" style="font-size: 1rem;">Skip to Chat</button>
    </div>
  </div>
</div>

<!-- Page 3: Chat Screen -->
<div id="page-chat" class="page" style="background: #f8f9fa; padding: 20px 0; font-family: 'Roboto', sans-serif;">
  <div class="container">
    <div class="main-container" style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
      
      <!-- LEFT COLUMN: Chat Column & New Homework Query Box -->
      <div style="flex: 3; display: flex; flex-direction: column; gap: 20px;">
        <!-- New Homework Query Box (Alternate method to ask a question) -->
        <div id="new-homework-box" style="display: flex; gap: 10px; align-items: center; padding: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
          <input id="new-homework-input" type="text" placeholder="Type a homework question..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem;">
          <button id="new-homework-ask" class="btn" style="padding: 8px 12px; border-radius: 4px; background: #007bff; color: #fff; border: none; font-size: 0.9rem;">Ask</button>
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container" style="
          min-height: 600px;
          display: flex;
          flex-direction: column;
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        ">
          <!-- Chat Header: Centered Logo -->
          <div class="chat-header" style="text-align: center; margin-bottom: 20px;">
            <img src="assets/bloobotblacktextcompressed.png" alt="Bloobot" style="max-width: 200px; width: 100%; height: auto; max-height: 80px;">
          </div>
          
          <!-- Messages Area (Outer Container) -->
          <div class="messages mb-3" id="messages" style="
            position: relative;
            height: 500px;
            overflow-y: auto;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
          ">
            <!-- Inner Container for messages (this will be blurred) -->
            <div id="messages-content">
              <!-- Initial Bot Message with New Session Button -->
              <div class="message bloo-message" style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                <img src="assets/bloobotlogoimage.png" alt="Bloo" style="width: 60px; height: 60px; margin-right: 10px; border-radius: 50%;">
                <div style="background: #e8f0ff; border-radius: 6px; padding: 10px 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 65%;">
                  <p style="margin: 0; color: #333;">Hi, I'm Bloo! I am an expert in your homework. How can I help?</p>
                </div>
              </div>
              <div id="initial-session-btn" style="text-align: right; margin-bottom: 15px;">
                <button class="new-session-btn btn" style="padding: 4px 8px; border-radius: 3px; background: transparent; color: #007bff; border: 1px solid #007bff; font-size: 0.8rem;">
                  New Homework Question
                </button>
              </div>
            </div>
          </div>
          
          <!-- Progress Bar & Thinking Indicator -->
          <div id="progressContainer" style="margin-bottom: 10px; position: relative;">
            <div id="progressBar" style="width: 0%; height: 4px; background: #007bff; border-radius: 2px;"></div>
            <!-- Thinking indicator (for regular queries) -->
            <div id="thinking-indicator" style="display: none; font-style: italic; color: #555; margin-top: 5px;">
              Bloo is thinking...
            </div>
          </div>
          
          <!-- Chat Input (Main Chat Input) -->
          <div class="chat-input-container" style="
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #fff;
          ">
            <textarea id="prompt" class="form-control" placeholder="Ask a question..." rows="1" style="
              flex: 1;
              border: none;
              outline: none;
              resize: none;
              font-size: 16px;
            "></textarea>
            <button id="send" class="btn" style="
              background: #fff;
              border: none;
              padding: 10px;
              border-radius: 50%;
              margin-left: 5px;
              transition: transform 0.2s ease;
            ">
              <img src="assets/ppsend-icon.svg" alt="Send" style="width: 31px; height: 30px;">
            </button>
          </div>
        </div>
        
        <!-- Elevated "Upload More Files" Button -->
        <div class="text-center" style="margin-top: 20px;">
          <button id="back-to-upload-btn" class="btn" style="
            background: linear-gradient(135deg, #0d6efd, #4285f4);
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'">
            Upload More Files
          </button>
        </div>
      </div>
      
      <!-- RIGHT COLUMN: Feature Cards -->
      <div class="feature-cards" style="
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      ">
        <!-- Feature Card Template -->
        <div class="card feature-box text-center" style="
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        ">
          <button class="btn btn-primary preset-btn mb-2" data-prompt="Please analyze my course materials." style="width: 100%; border-radius: 25px;">Analyze Materials</button>
          <h4 style="margin-top: 10px; color: #333;">Course Material Analysis</h4>
          <p style="font-size: 0.95rem; color: #555;">
            Let Bloo analyze your uploaded course materials. Receive clear summaries and insights tailored to your syllabus.
          </p>
        </div>
        <div class="card feature-box text-center" style="
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        ">
          <button class="btn btn-primary preset-btn mb-2" data-prompt="Help me break down my homework." style="width: 100%; border-radius: 25px;">Help with Homework</button>
          <h4 style="margin-top: 10px; color: #333;">Homework Breakdown</h4>
          <p style="font-size: 0.95rem; color: #555;">
            Struggling with assignments? Bloo breaks down your homework into manageable steps, guiding you through each task.
          </p>
        </div>
        <div class="card feature-box text-center" style="
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        ">
          <button class="btn btn-primary preset-btn mb-2" data-prompt="I need interactive study guidance." style="width: 100%; border-radius: 25px;">Study Guidance</button>
          <h4 style="margin-top: 10px; color: #333;">Interactive Study Guidance</h4>
          <p style="font-size: 0.95rem; color: #555;">
            Elevate your study game with personalized tips, curated resources, and dynamic Q&amp;A sessions to boost your learning.
          </p>
        </div>
        <div class="card feature-box text-center" style="
          background: #fff;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        ">
          <button class="btn btn-primary preset-btn mb-2" data-prompt="Export my chat history." style="width: 100%; border-radius: 25px;">Export Chat</button>
          <h4 style="margin-top: 10px; color: #333;">Export Chat History</h4>
          <p style="font-size: 0.95rem; color: #555;">
            Download your conversation history as a text file to review and reflect on your learning.
          </p>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Custom Modal for New Homework Session Confirmation -->
<div id="session-modal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  align-items: center;
  justify-content: center;
">
  <div id="modal-content" style="
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 90%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    text-align: center;
  ">
    <p style="font-size: 1rem; color: #333; margin-bottom: 20px;">
      Ask a new homework question? This will clear the current conversation.
    </p>
    <div>
      <button id="modal-yes" class="btn" style="
        margin-right: 10px;
        padding: 8px 16px;
        border-radius: 5px;
        background: #160054;
        color: #fff;
        border: none;
        font-size: 0.9rem;
      ">Yes, ask new question</button>
      <button id="modal-continue" class="btn" style="
        padding: 8px 16px;
        border-radius: 5px;
        background: #28a745;
        color: #fff;
        border: none;
        font-size: 0.9rem;
      ">Continue current question</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Global conversation state
  var conversation = [];
  var API_URL = window.location.hostname === "localhost" ? "http://localhost:8888/.netlify/functions/ask" : "/.netlify/functions/ask";
  
  // References to key elements
  var messagesDiv = document.getElementById('messages');
  // Reference the inner messages container
  var messagesContent = document.getElementById('messages-content');
  var promptEl = document.getElementById('prompt');
  var sendBtn = document.getElementById('send');
  var newHomeworkInput = document.getElementById('new-homework-input');
  var newHomeworkAsk = document.getElementById('new-homework-ask');
  
  // Modal references
  var sessionModal = document.getElementById('session-modal');
  var modalYesBtn = document.getElementById('modal-yes');
  var modalContinueBtn = document.getElementById('modal-continue');
  var thinkingIndicator = document.getElementById('thinking-indicator');
  
  // Global spinner overlay element for new homework queries
  var spinnerOverlay = null;
  
  // ---- Spinner Overlay Functions ----
  function showSpinnerOverlay() {
    var overlay = document.createElement('div');
    overlay.id = "spinner-overlay";
    overlay.style.position = "absolute";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.background = "rgba(255,255,255,0.8)";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.zIndex = "10";
    var spinnerImg = document.createElement('img');
    spinnerImg.src = "assets/infinite-spinner.svg";
    spinnerImg.alt = "Loading...";
    spinnerImg.style.width = "50px";
    spinnerImg.style.height = "50px";
    overlay.appendChild(spinnerImg);
    // Append overlay to the outer messages container (so it isn't blurred)
    messagesDiv.appendChild(overlay);
    // Apply blur to only the inner messages content
    messagesContent.style.filter = "blur(4px)";
    return overlay;
  }
  
  function hideSpinnerOverlay() {
    var overlay = document.getElementById("spinner-overlay");
    if (overlay) {
      overlay.remove();
    }
    messagesContent.style.filter = "none";
    spinnerOverlay = null;
  }
  
  // ---- Markdown and Typewriter Functions ----
  function markdownToHTML(markdown) {
    var output = markdown;
    output = output.replace(/^###### (.*)$/gm, '<h6>$1</h6>');
    output = output.replace(/^##### (.*)$/gm, '<h5>$1</h5>');
    output = output.replace(/^#### (.*)$/gm, '<h4>$1</h4>');
    output = output.replace(/^### (.*)$/gm, '<h3>$1</h3>');
    output = output.replace(/^## (.*)$/gm, '<h2>$1</h2>');
    output = output.replace(/^# (.*)$/gm, '<h1>$1</h1>');
    output = output.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    output = output.replace(/\*(.+?)\*/g, '<em>$1</em>');
    output = output.replace(/(?:^|\n)[-+*]\s+(.*)/g, '\n<li>$1</li>');
    output = output.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
    return output;
  }
  
  function intoPieces(text) {
    if (/^\s*$/.test(text)) return [text];
    var pieces = text.match(/(\s*\S+\s*)/g);
    return pieces || [];
  }
  
  function addBotMessageWithFormattingAndTyping(text, wpm) {
    var msgDiv = document.createElement('div');
    msgDiv.className = 'message bloo-message';
    msgDiv.style.display = 'flex';
    msgDiv.style.alignItems = 'flex-start';
    msgDiv.style.marginBottom = '15px';
  
    var avatar = document.createElement('img');
    avatar.src = 'assets/bloobotlogoimage.png';
    avatar.alt = 'Bloo';
    avatar.style.width = '60px';
    avatar.style.height = '60px';
    avatar.style.marginRight = '10px';
    avatar.style.borderRadius = '50%';
  
    var bubble = document.createElement('div');
    bubble.style.background = '#e8f0ff';
    bubble.style.borderRadius = '6px';
    bubble.style.padding = '10px 15px';
    bubble.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
    bubble.style.maxWidth = '65%';
  
    var p = document.createElement('p');
    p.style.margin = '0';
    p.style.color = '#333';
    bubble.appendChild(p);
  
    msgDiv.appendChild(avatar);
    msgDiv.appendChild(bubble);
    messagesContent.appendChild(msgDiv);
  
    // Append a minimal new session button after the bot message
    messagesContent.appendChild(createNewSessionButton());
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
    var pieces = intoPieces(text);
    var wordsPerMillisecond = wpm / 60000;
    var now = Date.now();
    var interval = setInterval(function() {
      var elapsed = Date.now() - now;
      var expectedCount = Math.min(elapsed * wordsPerMillisecond, pieces.length);
      var segment = pieces.slice(0, expectedCount + 1).join('');
      p.innerHTML = markdownToHTML(segment);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (expectedCount >= pieces.length) clearInterval(interval);
    }, 200);
  }
  
  // Function to create a minimal "New Homework Question" button
  function createNewSessionButton() {
    var btnDiv = document.createElement('div');
    btnDiv.style.textAlign = 'right';
    btnDiv.style.marginBottom = '15px';
    var btn = document.createElement('button');
    btn.className = 'new-session-btn btn';
    btn.style.cssText = "padding: 4px 8px; border-radius: 3px; background: transparent; color: #007bff; border: 1px solid #007bff; font-size: 0.8rem;";
    btn.textContent = "New Homework Question";
    btn.addEventListener('click', function() {
      sessionModal.style.display = 'flex';
    });
    btnDiv.appendChild(btn);
    return btnDiv;
  }
  
  // Function to process a user query (sends query to backend)
  async function processUserQuery(query, clearHistory) {
    if (!query.trim()) return;
    // If query comes from new-homework box, clear conversation and show spinner overlay
    if (clearHistory) {
      conversation = [];
      messagesContent.innerHTML = '';
      spinnerOverlay = showSpinnerOverlay();
    }
    conversation.push({ role: 'user', content: query });
    addMessage("You: " + query, 'user');
    startProgress();
    try {
      var ns = "default"; // Replace with actual user namespace if available.
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversation: conversation, userNamespace: ns })
      });
      const data = await response.json();
      if (data.response) {
        conversation.push({ role: 'assistant', content: data.response });
        addBotMessageWithFormattingAndTyping(data.response, 1000);
      } else {
        addMessage("Whoops, I didn't get that. Can you ask me again please?", 'bot');
      }
    } catch (err) {
      console.error(err);
      addMessage("Bloo: Error connecting to server.", 'bot');
    } finally {
      finishProgress();
    }
  }
  
  // ---- Progress and Thinking Indicator Functions ----
  function startProgress() {
    var progressBar = document.getElementById('progressBar');
    progressBar.style.width = '50%';
    // For regular queries (when spinnerOverlay isn't set), show the thinking text
    if (!spinnerOverlay) {
      thinkingIndicator.style.display = 'block';
    }
  }
  
  function finishProgress() {
    var progressBar = document.getElementById('progressBar');
    progressBar.style.width = '100%';
    setTimeout(function() { 
      progressBar.style.width = '0%'; 
      thinkingIndicator.style.display = 'none';
      if (spinnerOverlay) {
         hideSpinnerOverlay();
      }
    }, 500);
  }
  
  // ---- Event Listeners ----
  
  // Main chat send button event
  sendBtn.addEventListener('click', function() {
    var query = promptEl.value;
    promptEl.value = '';
    promptEl.style.height = 'auto';
    processUserQuery(query, false);
  });
  
  promptEl.addEventListener('keydown', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
  
  // New Homework Query Box: Enter key support
  newHomeworkInput.addEventListener('keydown', function(e) {
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      newHomeworkAsk.click();
    }
  });
  
  // New Homework Query Box: Ask button event; automatically clear history and show spinner overlay
  newHomeworkAsk.addEventListener('click', function() {
    var query = newHomeworkInput.value;
    newHomeworkInput.value = '';
    processUserQuery(query, true);
  });
  
 // Modal "Yes" button: clear conversation and reset chat with initial greeting and new session button
modalYesBtn.addEventListener('click', function() {
  conversation = [];
  // Clear the entire outer messages container
  messagesDiv.innerHTML = '';
  // Recreate the inner messages container and update the global reference
  var newContent = document.createElement('div');
  newContent.id = 'messages-content';
  messagesDiv.appendChild(newContent);
  messagesContent = newContent; // Update the global variable so new messages append here
  
  // Insert the initial bot greeting into the new inner container
  var initialMsg = document.createElement('div');
  initialMsg.className = 'message bloo-message';
  initialMsg.style.cssText = "display: flex; align-items: flex-start; margin-bottom: 15px;";
  initialMsg.innerHTML = `
    <img src="assets/bloobotlogoimage.png" alt="Bloo" style="width: 60px; height: 60px; margin-right: 10px; border-radius: 50%;">
    <div style="background: #e8f0ff; border-radius: 6px; padding: 10px 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 65%;">
      <p style="margin: 0; color: #333;">Hi, I'm Bloo! I am an expert in your homework. How can I help?</p>
    </div>`;
  messagesContent.appendChild(initialMsg);
  messagesContent.appendChild(createNewSessionButton());
  
  sessionModal.style.display = 'none';
});

  
  // Modal "Continue" button: simply close the modal
  modalContinueBtn.addEventListener('click', function() {
    sessionModal.style.display = 'none';
  });
  
  // Function to add a plain message (for user messages) with auto-scroll
  function addMessage(text, sender) {
    var msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + sender;
    if(sender === 'bot'){
      msgDiv.innerHTML = "<img src='assets/bloobotlogoimage.png' alt='Bloo' style='width:20px;height:20px;vertical-align:middle;margin-right:8px;'><strong>Bloo: </strong>" + text;
    } else {
      msgDiv.textContent = text;
    }
    messagesContent.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
});
</script>



<!-- Loading Overlay for file uploads -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="upload-progress-container">
    <div id="upload-progress-bar"></div>
  </div>
</div>

  <!-- Notification Popup -->
  <div id="notification-popup">File uploaded successfully!</div>

  <!-- Script dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <!-- Combined Auth0 and Bloobot logic -->
  <script>
    // --------- Utility: Simple Router with Transitions -----------
    function showPage(pageId) {
      $('.page').hide();
      $('#' + pageId).fadeIn(300, function() {
        $(this).css("pointer-events", "auto");
      });
    }

    // --------- Auth0 Integration -----------
    let auth0Client = null;
    let userProfile = null;

    const fetchAuthConfig = () => fetch("/auth_config.json");

    const configureClient = async () => {
      try {
        const response = await fetchAuthConfig();
        const config = await response.json();
        auth0Client = await auth0.createAuth0Client({
          domain: config.domain,
          clientId: config.clientId,
          redirect_uri: window.location.origin,
          cacheLocation: "localstorage"
        });
      } catch (err) {
        console.log("Error configuring Auth0 client:", err);
      }
    };

    const login = async (targetUrl) => {
      try {
        const options = {
          authorizationParams: {
            redirect_uri: window.location.origin,
            scope: "openid profile email"
          }
        };
        if (targetUrl) { options.appState = { targetUrl }; }
        await auth0Client.loginWithRedirect(options);
      } catch (err) {
        console.log("Log in failed", err);
      }
    };

    const logout = async () => {
      try {
        await auth0Client.logout({
          logoutParams: { returnTo: window.location.origin }
        });
        updateAuthUI();
        showPage("page-welcome");
      } catch (err) {
        console.log("Log out failed", err);
      }
    };

    const updateAuthUI = async () => {
      try {
        const isAuthenticated = await auth0Client.isAuthenticated();
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        if (isAuthenticated) {
          userProfile = await auth0Client.getUser();
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
        } else {
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
        }
      } catch (err) {
        console.log("Error updating UI!", err);
      }
    };

    // --------- Attach Auth0 event listeners and process redirect callback -----------
    window.onload = async () => {
      await configureClient();
      document.getElementById("login-btn").disabled = false;

      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        try {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, "/");
          window.location.reload();
          return;
        } catch (err) {
          console.log("Error parsing redirect:", err);
        }
      }
      await updateAuthUI();

      const isAuthenticated = await auth0Client.isAuthenticated();
      // If user is authenticated, show page-info, else show page-landing
      if (isAuthenticated) {
        showPage("page-info");
      } else {
        showPage("page-landing");
      }

      document.getElementById("back-to-landing-btn").addEventListener("click", () => {
        showPage("page-landing");
      });
      // Attach event listeners for auth buttons
      document.getElementById("landing-get-started-btn").addEventListener("click", () => {
        // For example, go to the welcome screen
        showPage("page-welcome");
      });
      document.getElementById("landing-signup-btn").addEventListener("click", () => {
        // Trigger sign up flow
        login();
      });

      document.getElementById("back-to-info-btn").addEventListener("click", () => {
        showPage("page-info");
      });

      document.getElementById("sign-in-btn").addEventListener("click", () => {
        console.log("Sign In clicked");
        login();
      });
      document.getElementById("create-account-btn").addEventListener("click", () => {
        console.log("Create Account clicked");
        login();
      });
      document.getElementById("login-btn").addEventListener("click", () => {
        console.log("Login button clicked");
        login();
      });
      document.getElementById("logout-btn").addEventListener("click", () => {
        logout();
      });

      // New Info Page Buttons
      document.getElementById("upload-files-btn").addEventListener("click", () => {
        showPage("page-upload");
      });
      document.getElementById("skip-to-bloo-btn").addEventListener("click", () => {
        showPage("page-chat");
      });

      // Attach event listener for "Chat with Bloo" button on the Upload Page
      document.getElementById("chat-btn").addEventListener("click", () => {
        showPage("page-chat");
      });
    };

    document.getElementById("skip-btn").addEventListener("click", () => {
      showPage("page-chat");
    });

    document.getElementById("back-to-upload-btn").addEventListener("click", () => {
      showPage("page-upload");
    });

    document.getElementById('prompt').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    let conversation = [];
    const messagesEl = document.getElementById('messages');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const API_URL = window.location.hostname === "localhost"
      ? "http://localhost:8888/.netlify/functions/ask"
      : "/.netlify/functions/ask";

    function addMessage(text, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender + ' mb-2';
      if(sender === "bot"){
        msgDiv.innerHTML = "<img src='assets/bloobotlogoimage.png' alt='Bloo Logo' style='width:20px;height:20px;vertical-align:middle;margin-right:8px;'><strong>Bloo: </strong>" + text;
      } else {
        msgDiv.textContent = text;
      }
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Enhanced markdown parser: converts headings, bold, italic and bullet lists
    function markdownToHTML(markdown) {
      let output = markdown;
      // Convert headings
      output = output.replace(/^###### (.*)$/gm, '<h6>$1</h6>');
      output = output.replace(/^##### (.*)$/gm, '<h5>$1</h5>');
      output = output.replace(/^#### (.*)$/gm, '<h4>$1</h4>');
      output = output.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      output = output.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      output = output.replace(/^# (.*)$/gm, '<h1>$1</h1>');
      // Bold and italic
      output = output.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      output = output.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Unordered list items: lines starting with -, +, or *
      output = output.replace(/(?:^|\n)[-+*]\s+(.*)/g, '\n<li>$1</li>');
      // Ordered list items: lines starting with a number and a period
      output = output.replace(/(?:^|\n)\d+\.\s+(.*)/g, '\n<li>$1</li>');
      // Wrap contiguous <li> blocks in an unordered list
      output = output.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
      return output;
    }

    function intoPieces(text) {
      if (/^\s*$/.test(text)) return [text];
      const pieces = text.match(/(\s*\S+\s*)/g);
      return pieces || [];
    }

    function typeWriter(text, element, speed = 30) {
      let i = 0;
      const interval = setInterval(() => {
        element.innerHTML = "<img src='assets/bloobotlogoimage.png' alt='Bloo Logo' style='width:20px;height:20px;vertical-align:middle;margin-right:8px;'><strong>Bloo: </strong>" + markdownToHTML(text.substring(0, i));
        i++;
        if (i > text.length) clearInterval(interval);
      }, speed);
    }

    // =========================================
    // UPDATED addBotMessageWithFormattingAndTyping()
    // to create Bloo's bigger bubble with typed markdown
    // =========================================
    function addBotMessageWithFormattingAndTyping(text, wpm) {
      // Create a container for Bloo's bigger avatar + bubble
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message bloo-message mb-2';
      msgDiv.style.display = 'flex';
      msgDiv.style.alignItems = 'flex-start';
      msgDiv.style.marginBottom = '15px';

      // Bloo's Larger Avatar
      const avatar = document.createElement('img');
      avatar.src = 'assets/bloobotlogoimage.png';
      avatar.alt = 'Bloo';
      avatar.style.width = '60px';
      avatar.style.height = '60px';
      avatar.style.marginRight = '2px';
      avatar.style.borderRadius = '50%';

      // Bubble container
      const bubble = document.createElement('div');
      bubble.style.background = '#e8f0ff';
      bubble.style.borderRadius = '6px';
      bubble.style.padding = '10px 15px';
      bubble.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
      bubble.style.maxWidth = '85%';

      // Paragraph inside bubble for typed text
      const p = document.createElement('p');
      p.style.margin = '0';
      p.style.color = '#333';
      bubble.appendChild(p);

      // Assemble
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubble);
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // Typewriter effect with markdown
      const pieces = intoPieces(text);
      const wordsPerMillisecond = wpm / 60000;
      const now = Date.now();
      const interval = setInterval(() => {
        const elapsed = Date.now() - now;
        const expectedCount = Math.min(elapsed * wordsPerMillisecond, pieces.length);
        const segment = pieces.slice(0, expectedCount + 1).join('');
        p.innerHTML = markdownToHTML(segment);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        if (expectedCount >= pieces.length) clearInterval(interval);
      }, 200);
    }
    // =========================================

    let progressInterval;
    function startProgress() {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = '0%';
      progressContainer.style.display = 'block';
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          progressBar.style.width = progress + '%';
        } else {
          clearInterval(progressInterval);
        }
      }, 200);
    }
    function finishProgress() {
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = '100%';
      clearInterval(progressInterval);
      setTimeout(() => { document.getElementById('progressContainer').style.display = 'none'; }, 500);
    }

    sendBtn.addEventListener('click', async () => {
  const promptText = promptEl.value.trim();
  if (!promptText) return;
  conversation.push({ role: 'user', content: promptText });
  addMessage("You: " + promptText, 'user');
  // Clear the textarea and reset its height to collapse it back to its default size
  promptEl.value = '';
  promptEl.style.height = 'auto';
  startProgress();
  try {
    const ns = userProfile ? (userProfile.nickname || userProfile.name || userProfile.email) : "default";
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ conversation: conversation, userNamespace: ns })
    });
    const data = await response.json();
    if (data.response) {
      conversation.push({ role: 'assistant', content: data.response });
      addBotMessageWithFormattingAndTyping(data.response, 1000);
    } else {
      addMessage("Whoops, I didn't get that. Can you ask me again please?", 'bot');
    }
  } catch (err) {
    console.error(err);
    addMessage("Bloo: Error connecting to server.", 'bot');
  } finally {
    finishProgress();
  }
});


    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    document.querySelectorAll('.preset-btn').forEach(button => {
      button.addEventListener('click', () => {
        promptEl.value = button.getAttribute('data-prompt');
        sendBtn.click();
      });
    });

    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("fileUpload");

    dropZone.addEventListener("click", () => { fileInput.click(); });
    dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("hover"); });
    dropZone.addEventListener("dragleave", (e) => { e.preventDefault(); dropZone.classList.remove("hover"); });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      const droppedFiles = e.dataTransfer.files;
      if (droppedFiles.length) {
        updateFileList(Array.from(droppedFiles));
        handleFileUploads(droppedFiles);
      }
    });

    fileInput.addEventListener("change", (e) => {
      const selectedFiles = e.target.files;
      if (selectedFiles.length) {
        updateFileList(Array.from(selectedFiles));
        handleFileUploads(selectedFiles);
        // Clear the file input so that the same file can be selected again if needed
        fileInput.value = "";
      }
    });

    let uploadProgressInterval;
    function startUploadProgress() {
      const container = document.getElementById("upload-progress-container");
      const bar = document.getElementById("upload-progress-bar");
      bar.style.width = "0%";
      container.style.display = "block";
      let progress = 0;
      uploadProgressInterval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          bar.style.width = progress + "%";
        } else {
          clearInterval(uploadProgressInterval);
        }
      }, 200);
    }
    function finishUploadProgress() {
      const bar = document.getElementById("upload-progress-bar");
      bar.style.width = "100%";
      clearInterval(uploadProgressInterval);
      setTimeout(() => { document.getElementById("upload-progress-container").style.display = "none"; }, 500);
    }
    function handleFileUploads(fileList) {
      document.getElementById("loading-overlay").style.display = "flex";
      startUploadProgress();
      const files = Array.from(fileList);
      const uploads = files.map(file => uploadFile(file));
      Promise.allSettled(uploads)
        .then((results) => {
          finishUploadProgress();
          const successful = results.filter(r => r.status === "fulfilled");
          if (successful.length > 0) {
            const notification = document.getElementById("notification-popup");
            notification.textContent = "File(s) uploaded successfully!";
            notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; }, 3000);
          } else {
            alert("All file uploads failed.");
          }
        })
        .catch((error) => {
          finishUploadProgress();
          alert("One or more file uploads failed.");
        })
        .finally(() => {
          setTimeout(() => { document.getElementById("loading-overlay").style.display = "none"; }, 500);
        });
    }
    async function uploadFile(file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/.netlify/functions/upload", true);
        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const result = JSON.parse(xhr.responseText);
              resolve(result);
            } catch (err) {
              reject(err);
            }
          } else {
            reject(new Error("Upload failed with status " + xhr.status));
          }
        };
        xhr.onerror = function() { reject(new Error("Network error")); };
        const formData = new FormData();
        formData.append("file", file, file.name);
        if (userProfile) {
          const ns = userProfile.nickname || userProfile.name || userProfile.email;
          formData.append("namespace", ns);
        }
        xhr.send(formData);
      });
    }
    function updateFileList(files) {
      const fileListContainer = document.getElementById("file-list");
      if (!fileListContainer) return;
      let html = "<ul class='list-group'>";
      files.forEach(file => {
        html += `<li class="list-group-item bg-light text-dark"><span class="file-icon">ðŸ“„</span>${file.name}</li>`;
      });
      html += "</ul>";
      fileListContainer.innerHTML = html;
    }
  </script>
  
<script>
  (function() {
    const fileInput = document.getElementById('fileUpload');
    const uploadedFilesList = document.getElementById('uploaded-files');

    // Attempt to load previously stored file names from localStorage
    let uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];

    function renderUploadedFiles() {
      // Clear the list and re-render all file names from the array
      uploadedFilesList.innerHTML = "";
      uploadedFiles.forEach(fileName => {
        const li = document.createElement('li');
        li.textContent = fileName;
        li.style.padding = '5px 0';
        uploadedFilesList.appendChild(li);
      });
    }

    function saveFiles() {
      // Save the array to localStorage
      localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
    }

    // On page load, render any previously stored data
    renderUploadedFiles();

    if (fileInput && uploadedFilesList) {
      fileInput.addEventListener('change', function(event) {
        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
          const fileName = files[i].name;
          // Add the file name to the persistent array
          uploadedFiles.push(fileName);
        }
        // Re-render the file list
        renderUploadedFiles();
        // Save to localStorage
        saveFiles();
        // Reset the file input to allow re-upload of the same file if needed
        fileInput.value = "";
      });
    }
    
  })();
</script>

  <script>
    // Only register the service worker if not running on localhost
    if (window.location.hostname !== 'localhost' && 'serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log("Service worker registered: ", registration);
        })
        .catch((error) => {
          console.error("Service worker registration failed: ", error);
        });
    } else {
      console.log("Service worker not registered in development (localhost).");
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js?v=2')
        .then(registration => {
          console.log('Service Worker registered!', registration.scope);
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    }
  </script>
  
</body>
</html>
